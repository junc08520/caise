// api/register.js

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const body = req.body || {};
    const {
      year,
      sponsor,
      fullname,
      phone,
      email,
      school,
      school_city,
      major,
      student_id,
      mail_address,
      note
    } = body;

    // åŸºæœ¬æ ¡éªŒ
    if (!year || !sponsor || !fullname || !phone || !school || !school_city || !mail_address) {
      return res.status(400).json({ error: 'Missing required fields' });
    }

    if (sponsor !== 'CÃ³') {
      return res.status(400).json({ error: 'Only applicants who opt-in for support are accepted' });
    }

    // ç¦æ­¢ TP.HCM / Há»“ ChÃ­ Minh ç­‰
    const forbidden = [
      'ho chi minh','há»“ chÃ­ minh','tp.hcm','tp hcm','hcm',
      'thÃ nh phá»‘ há»“ chÃ­ minh','sÃ i gÃ²n','sai gon','èƒ¡å¿—æ˜','èƒ¡å¿—æ˜å¸‚'
    ];
    const lower = (s) => (s || '').toString().toLowerCase();

    if (forbidden.some(k => lower(school).includes(k) || lower(school_city).includes(k))) {
      return res.status(400).json({ error: 'Not eligible for Ho Chi Minh City institutions' });
    }

    const time = new Date().toISOString();

    // 1) æ‰“æ—¥å¿—ï¼ˆåœ¨ Vercel Logs ä¸­æŸ¥çœ‹ï¼Œåšå®¡è®¡ & å¤‡ä»½ï¼‰
    console.log('VN_STUDENT_APPLICATION', {
      time,
      year,
      sponsor,
      fullname,
      phone,
      email,
      school,
      school_city,
      major,
      student_id,
      mail_address,
      note: note || ''
    });

    // 2) å¯é€‰ï¼šå‘é€åˆ° Telegramï¼ˆæ¨èç»™ä½ å›¢é˜Ÿç”¨ï¼‰
    // åœ¨ Vercel é¡¹ç›®ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š
    // TELEGRAM_BOT_TOKEN = xxxxxx
    // TELEGRAM_CHAT_ID = xxxxxx
    const botToken = process.env.TELEGRAM_BOT_TOKEN;
    const chatId = process.env.TELEGRAM_CHAT_ID;

    if (botToken && chatId) {
      const text =
`ğŸ“¥ Há»“ sÆ¡ sinh viÃªn má»›i (ChÆ°Æ¡ng trÃ¬nh Há»— Trá»£ SV VN)
Thá»i gian: ${time}
NÄƒm há»c: ${year === '1' ? 'Äáº¡i há»c nÄƒm 1' : 'Äáº¡i há»c nÄƒm 2'}
Mong muá»‘n há»— trá»£: ${sponsor}
Há» tÃªn: ${fullname}
SÄT: ${phone}
Email: ${email || '-'}
TrÆ°á»ng: ${school}
Tá»‰nh/TP cá»§a trÆ°á»ng: ${school_city}
NgÃ nh/Khoa: ${major || '-'}
MSSV: ${student_id || '-'}
Äá»‹a chá»‰ nháº­n thÆ°/bÆ°u pháº©m: ${mail_address}
Nhu cáº§u há»— trá»£: ${note || '-'}

âš  LiÃªn há»‡ chá»‰ qua: nhÃ  trÆ°á»ng / email xÃ¡c minh / bÆ°u Ä‘iá»‡n. KhÃ´ng yÃªu cáº§u chuyá»ƒn tiá»n hay cung cáº¥p thÃ´ng tin NH.`;

      await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text })
      });
    }

    // 3) å°†æ¥å¯åœ¨è¿™é‡Œæ¥æ•°æ®åº“ / Google Sheet

    return res.status(200).json({ ok: true });
  } catch (err) {
    console.error('REGISTER_ERROR', err);
    return res.status(500).json({ error: 'Server error' });
  }
}
